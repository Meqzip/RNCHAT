<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RN Treats AI Assistant</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .chat-container {
            max-width: 500px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 70vh; /* Set a fixed height for the chat window */
        }
        .chat-header {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: #e2e8f0; /* Light gray for messages area */
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            line-height: 1.5;
            word-wrap: break-word; /* Ensure long words break */
        }
        .user-message {
            background-color: #6366f1; /* Indigo 500 */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-message {
            background-color: #ffffff;
            color: #333;
            margin-right: auto;
            border: 1px solid #cbd5e0; /* Border for AI messages */
            border-bottom-left-radius: 0.25rem;
        }
        .chat-input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #cbd5e0; /* Light gray border */
            background-color: #ffffff;
        }
        .chat-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.75rem;
            margin-right: 0.75rem;
            outline: none;
            font-size: 1rem;
        }
        .send-button {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .send-button:hover {
            background-color: #4338ca; /* Indigo 700 */
        }
        .loading-indicator {
            text-align: center;
            padding: 1rem;
            color: #6b7280;
            font-style: italic;
        }
        /* Message box for alerts */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }
        .message-box-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .message-box {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #555;
        }
        .message-box button {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            font-weight: bold;
        }
        .message-box button:hover {
            background-color: #4338ca;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            RN Treats AI Assistant
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- Initial welcome message from AI -->
            <div class="message-bubble ai-message">
                Hello! Welcome to RN Treats. To help me get started, could you please tell me what kind of treat you're interested in (e.g., a custom cake, cupcakes, or finger foods)? Also, for a cake, what size or how many servings are you looking for, and for what date and time do you need it?
            </div>
        </div>
        <div class="loading-indicator hidden" id="loading-indicator">
            AI is typing...
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="Type your message...">
            <button id="send-button" class="send-button">
                Send
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.917H3.75a.75.75 0 0 0 0 1.5h1.918l-2.432 7.917a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.916.75.75 0 0 0 0-1.236A60.519 60.519 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box-overlay" class="message-box-overlay">
        <div class="message-box">
            <h3 id="message-box-title"></h3>
            <p id="message-box-content"></p>
            <button id="message-box-ok">OK</button>
        </div>
    </div>

    <!-- Firebase CDN scripts - loaded globally -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Wait for the DOM to be fully loaded before running the script
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM Content Loaded. Initializing Firebase and chat elements.");

            // Global Firebase variables (provided by Canvas environment)
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? initialAuthToken : null; // Fixed potential typo here

            let app, db, auth;

            // Initialize Firebase using compat versions
            try {
                // Check if firebase object is available
                if (typeof firebase === 'undefined') {
                    console.error("Firebase library not loaded. Check CDN links.");
                    showMessageBox("Error", "Firebase library not loaded. Chat functionality may be limited.");
                    return; // Exit if Firebase is not available
                }

                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore(app); // Use firebase.firestore for compat
                auth = firebase.auth(app);   // Use firebase.auth for compat
                console.log("Firebase app initialized.");

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await auth.signInWithCustomToken(initialAuthToken)
                        .then(() => console.log("Firebase signed in with custom token."))
                        .catch((error) => console.error("Firebase custom token sign-in error:", error));
                } else {
                    await auth.signInAnonymously()
                        .then(() => console.log("Firebase signed in anonymously."))
                        .catch((error) => console.error("Firebase anonymous sign-in error:", error));
                }
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showMessageBox("Error", "Failed to initialize Firebase. Chat functionality may be limited.");
            }

            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const loadingIndicator = document.getElementById('loading-indicator');

            // Message Box elements
            const messageBoxOverlay = document.getElementById('message-box-overlay');
            const messageBoxTitle = document.getElementById('message-box-title');
            const messageBoxContent = document.getElementById('message-box-content');
            const messageBoxOkButton = document.getElementById('message-box-ok');

            if (messageBoxOkButton) {
                messageBoxOkButton.addEventListener('click', () => {
                    messageBoxOverlay.classList.remove('visible');
                });
            } else {
                console.error("Message box OK button not found.");
            }

            function showMessageBox(title, message) {
                if (messageBoxTitle && messageBoxContent && messageBoxOverlay) {
                    messageBoxTitle.textContent = title;
                    messageBoxContent.textContent = message;
                    messageBoxOverlay.classList.add('visible');
                } else {
                    console.error("Message box elements not found for showing message.");
                }
            }

            // Function to display messages in the chat window
            function displayMessage(message, sender) {
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('message-bubble');
                if (sender === 'user') {
                    messageBubble.classList.add('user-message');
                } else {
                    messageBubble.classList.add('ai-message');
                }
                messageBubble.innerHTML = message; // Use innerHTML to allow bold/links
                chatMessages.appendChild(messageBubble);
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to the bottom
            }

            // Function to call the Gemini API
            async function getGeminiResponse(prompt) {
                loadingIndicator.classList.remove('hidden');
                sendButton.disabled = true; // Disable send button while AI is typing

                // Add RN Treats specific information to the AI's context
                const rnTreatsInfo = `
                    RN Treats is a home-based bakery specializing in custom cakes, cupcakes, finger foods, and catering for weddings, birthdays, and all your special events. We're here to bring your vision to life with personalized, handcrafted creations made fresh to order. We proudly offer gluten-free, eggless, vegan, and dairy-free options to suit your dietary needs.

                    **General Ordering Information:**
                    - All orders must be placed at least one day in advance to ensure the highest quality and freshness.
                    - Orders will be confirmed and submitted after the deposit is paid.
                    - Decoration fees for custom cakes are separate and depend on complexity. Cake prices listed below are base prices without decoration.

                    **Contact Information for Direct Assistance:**
                    - For the fastest response, message us directly on WhatsApp: +1 368 299 0257
                    - Instagram: @RNTREATSYYC
                    - Website: www.RNTREATS.com
                    - Email: info@rntreats.com
                    - Phone: +1-3682990257 (also WhatsApp)
                    - Facebook: RN Treats (Please note: For fastest response, WhatsApp is preferred)
                    - Address: 420 Hawkstone Manor Northwest, Calgary, AB, Canada
                    - Operating Hours: Mon-Sun - 09:00-21:00

                    **Custom Cakes Details:**
                    - Fresh, Delicious Cakes for Every Occasion.
                    - Customize your flavor, filling, and size.
                    - Dietary options available: gluten-free, eggless, vegan, and dairy-free.
                    - For special designs or custom decorations, please contact us to discuss your vision.
                    - For larger cake sizes or complex custom orders not listed, please contact us directly for personalized pricing.

                    **Cake Flavors:**
                    - Chocolate, Vanilla, Lemon, Coffee, Saffron, Tiramisu, Carrot, Red Velvet, Orange, Strawberry, Black Forest.

                    **Cake Filling Options:**
                    - Nuts: Almond, Walnut, Pistachio, Hazelnut, Cashew, Peanut
                    - Fruits: Pineapple, Strawberry, Raspberry, Blueberry, Blackberry, Banana, Cherry
                    - Sauce/Jam: Lemon Sauce, Custard, Caramel, Nutella, Dulce de Leche
                    - Chocolate: Chocolate Chips or Crumbs

                    **Cake Sizes & Base Prices (No Decoration):**
                    - 3" (3 layers) – $35 (serves 2)
                    - 4" (3 layers) – $45 (serves 4)
                    - 6" (3 layers) – $55 (serves 8)
                    - 6" (4 layers) – $65 (serves 10)
                    - 6" (5 layers) – $80 (serves 12)
                    - 8" (2 layers) – $80 (serves 15)
                    - 8" (3 layers) – $95 (serves 18)
                    - 8" (4 layers) – $110 (serves 20)
                    - 10" (2 layers) – $115 (serves 25)
                    - 10" (4 layers) – $145 (serves 30)
                    - 12" (2 layers) – $150 (serves 35)
                    - 12" (3 layers) – $165 (serves 40)
                    - 14" (2 layers) – $170 (serves 50)
                    - 14" (3 layers) – $210 (serves 60)

                    **Finger Foods Selection & Prices:**
                    - Ham Roll – $2.5 each
                    - Ham and Cheese Canapé with Avocado Sauce – $2.5 each
                    - Tuna and Parsley Canapé – $2.5 each
                    - Sausage Canapé – $2.5 each
                    - Spinach and Cheese Börek – $3.5 each
                    - Coin Pizza – $2.5 each
                    - Homemade Garlic Bread Roll – $1.5 each
                    - Homemade Chicken Nuggets – $2.5 each
                    - Spring Roll with Ham and Cheese – $2.5 each
                    - Mini Quiche (Vegetable or Bacon) – $3.5 each
                    - Stuffed Grape Leaves (Dolma) – $2.5 each
                    - Falafel Balls with Tzatziki Sauce – $2.5 each
                    - Cheese and Olive Skewers – $3.5 each
                    - Grilled Chicken Skewers with Vegetables – $5.5 each
                    - Garlic and Ham Canapé (each bite) – $2.5
                    - Vegetable Frittata with Fresh Greens (each bite) – $3.5
                    - Mini Beef Sliders – $4.5 each
                    - Bruschetta with Tomato & Basil – $2.5 each
                    - Mozzarella Sticks – $2.5 each
                    - Stuffed Mushrooms – $3.5 each
                `;

                let chatHistory = [];
                // The AI's initial prompt to guide its first response, which is hardcoded in the HTML.
                // This prompt is for subsequent AI responses after the initial user query.
                const aiInstructionPrompt = `You are an AI assistant for RN Treats, a home-based bakery. Your primary goal is to gather initial order details (product type, size/servings, date/time) and provide base pricing.

                **Here's your conversational flow:**
                1.  **Initial Interaction (already handled by welcome message):** The user has just seen the welcome message asking for treat type, size/servings, and date/time.
                2.  **Gathering Details:** Based on the user's input, try to gather all necessary details to provide a base price.
                    * If they mention a cake, ask for size (e.g., 6", 8") and layers (e.g., 3 layers, 4 layers) or servings.
                    * If they mention finger foods, ask for specific items and quantities.
                    * Always confirm the desired date and time.
                3.  **Provide Base Pricing:** If you have enough information to calculate a base price from the 'RN Treats Information' provided below, state the base price clearly.
                    * **ALWAYS state:** "Decoration fees for custom cakes are separate and depend on complexity."
                4.  **Forwarding for Complex/Finalization:**
                    * If the user expresses a desire to finalize an order, discuss complex designs, or asks a question you cannot answer with the provided 'RN Treats Information', then provide ALL contact information for direct chat.
                    * **When forwarding, use this exact phrase and contact details:** "It sounds like you're ready to finalize something or need direct assistance! For the fastest response, please message RN Treats directly on WhatsApp: **+1 368 299 0257**. You can also reach us via Instagram: **@RNTREATSYYC**, Phone: **+1-3682990257**, Email: **info@rntreats.com**, or find us on Facebook at **RN Treats**."

                **RN Treats Information (for your reference):**
                ${rnTreatsInfo}

                User's current query: ${prompt}`;

                chatHistory.push({ role: "user", parts: [{ text: aiInstructionPrompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyD4ODQXM_NSG6l6RRn_ARdGdzrtqAZWkRI"; // Canvas will automatically provide this in runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content[0] && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        console.error("Unexpected API response structure:", result);
                        return "I'm sorry, I couldn't get a response from the AI. Please try again.";
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    return "I'm having trouble connecting right now. Please check your internet connection or try again later.";
                } finally {
                    loadingIndicator.classList.add('hidden');
                    sendButton.disabled = false; // Re-enable send button
                }
            }

            // Function to handle sending messages
            async function sendMessage() {
                console.log("sendMessage function triggered.");
                const userMessage = chatInput.value.trim();
                if (userMessage === '') {
                    console.log("User message is empty, not sending.");
                    return;
                }

                displayMessage(userMessage, 'user');
                chatInput.value = ''; // Clear input

                // Check for keywords to "forward" to the user
                const forwardKeywords = ['finalize', 'book', 'order', 'contact', 'speak to a person', 'talk to someone', 'need help', 'whatsapp', 'email', 'instagram', 'phone', 'facebook', 'call', 'message'];
                const needsForward = forwardKeywords.some(keyword => userMessage.toLowerCase().includes(keyword));

                if (needsForward) {
                    console.log("Forwarding to direct contact based on keywords.");
                    const contactMess
